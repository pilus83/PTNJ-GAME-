<!DOCTYPE html>
<html lang="ms">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Renjer Johor: Misi Taman Negara</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #1a202c;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            touch-action: none;
        }

        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        canvas {
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            width: 100vw;
            height: 100vh;
            max-width: 100%;
            max-height: 100%;
            aspect-ratio: 16 / 9;
            object-fit: contain;
        }

        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            z-index: 10;
        }

        .hidden {
            display: none !important;
        }

        .title-screen {
            background-image: url('bg_jungle.png');
            background-color: #1a3320;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .jungle-title {
            font-family: 'Fredoka One', 'Titan One', 'Arial Black', sans-serif;
            font-size: clamp(2rem, 6vw, 4rem);
            color: #FFF9D2;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-align: center;

            -webkit-text-stroke: 1px #8E4A0B;
            text-shadow:
                0px 1px 0px #FFC107,
                0px 2px 0px #FF9800,
                0px 4px 0px #D84315,
                0px 6px 0px #5D4037,
                0px 10px 10px rgba(0, 0, 0, 0.6);

            margin-bottom: 1rem;
            line-height: 1.2;
            z-index: 10;
            width: 100%;
            max-width: 450px;
            /* Match max-width with panel */

            background: linear-gradient(to bottom, #C47A41, #965321);
            padding: 20px 0;
            border-radius: 15px;
            /* Less rounded per screenshot */
            border: 4px solid #4A2912;
            box-shadow:
                inset 0px 4px 0px rgba(255, 255, 255, 0.15),
                inset 0px -3px 0px rgba(0, 0, 0, 0.2),
                0px 5px 0px #311A0B,
                0px 10px 15px rgba(0, 0, 0, 0.5);
        }

        .jungle-panel {
            background-color: #F5E6C8;
            border: 6px solid #8B4513;
            border-radius: 20px;
            /* Less rounded */
            box-shadow:
                inset 0 0 0 3px #D2B48C,
                0px 8px 15px rgba(0, 0, 0, 0.6);
            color: #1A365D;
            /* Darker blue text per screenshot */
            padding: 2rem 2rem;
            max-width: 450px;
            width: 90%;
            text-align: center;
            position: relative;
            z-index: 10;
        }

        .jungle-btn {
            background: linear-gradient(to bottom, #74C328, #4CA109);
            color: #fff;
            border: 2px solid #005600;
            border-radius: 15px;
            /* less rounded */
            font-size: 1.1rem;
            font-weight: 800;
            padding: 12px 20px;
            text-transform: capitalize;
            box-shadow:
                inset 0px 2px 0px rgba(255, 255, 255, 0.4),
                0px 4px 0px #005600,
                0px 6px 8px rgba(0, 0, 0, 0.3);
            text-shadow: 1px 1px 1px rgba(0, 0, 0, 0.5);
            transition: all 0.1s;
            cursor: pointer;
            width: 100%;
            font-family: 'Arial Rounded MT Bold', sans-serif;
            margin-bottom: 0.5rem;
        }

        .jungle-btn:active {
            transform: translateY(6px);
            box-shadow:
                inset 0px 3px 0px rgba(255, 255, 255, 0.4),
                0px 0px 0px #005600,
                0px 2px 5px rgba(0, 0, 0, 0.3);
        }

        .jungle-btn-red {
            background: linear-gradient(to bottom, #FF5B4F, #D32F2F);
            border-color: #8B0000;
            box-shadow:
                inset 0px 3px 0px rgba(255, 255, 255, 0.4),
                0px 6px 0px #8B0000,
                0px 10px 10px rgba(0, 0, 0, 0.3);
        }

        .jungle-btn-red:active {
            box-shadow:
                inset 0px 3px 0px rgba(255, 255, 255, 0.4),
                0px 0px 0px #8B0000,
                0px 2px 5px rgba(0, 0, 0, 0.3);
        }

        .jungle-btn-blue {
            background: linear-gradient(to bottom, #4FC3F7, #0288D1);
            border-color: #01579B;
            box-shadow:
                inset 0px 3px 0px rgba(255, 255, 255, 0.4),
                0px 6px 0px #01579B,
                0px 10px 10px rgba(0, 0, 0, 0.3);
        }

        .jungle-btn-blue:active {
            box-shadow:
                inset 0px 3px 0px rgba(255, 255, 255, 0.4),
                0px 0px 0px #01579B,
                0px 2px 5px rgba(0, 0, 0, 0.3);
        }

        #hud {
            position: absolute;
            top: 20px;
            left: 20px;
            font-size: 20px;
            font-weight: bold;
            color: #5C4033;
            text-shadow: 1px 1px 0px rgba(255, 255, 255, 0.7);
            z-index: 5;
            pointer-events: none;
            background: #F5E6C8;
            border: 4px solid #8B4513;
            box-shadow:
                inset 0 0 0 2px #D2B48C,
                0px 6px 0px rgba(0, 0, 0, 0.5);
            padding: 10px 20px;
            border-radius: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .text-red {
            color: #E53E3E !important;
        }

        #touch-controls {
            position: absolute;
            bottom: 20px;
            width: 100%;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            z-index: 5;
            box-sizing: border-box;
        }

        .btn-touch {
            background: rgba(255, 255, 255, 0.3);
            border: 2px solid white;
            border-radius: 50%;
            width: 70px;
            height: 70px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 30px;
            color: white;
            user-select: none;
            backdrop-filter: blur(5px);
        }

        .btn-touch:active {
            background: rgba(255, 255, 255, 0.6);
        }

        .dir-buttons {
            display: flex;
            gap: 15px;
        }

        @media (min-width: 768px) {
            #touch-controls {
                display: none;
            }
        }

        /* Admin Table Styles */
        .admin-table-container {
            max-height: 200px;
            overflow-y: auto;
            width: 100%;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }

        .admin-table {
            width: 100%;
            border-collapse: collapse;
            color: black;
            font-size: 12px;
        }

        .admin-table th,
        .admin-table td {
            padding: 6px;
            border-bottom: 1px solid #ddd;
            text-align: left;
        }

        .admin-table th {
            background-color: #2b6cb0;
            color: white;
            position: sticky;
            top: 0;
        }

        .admin-table tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        .admin-table tr:hover {
            background-color: #e2e8f0;
        }
    </style>
</head>

<body>

    <div id="game-container">
        <div id="hud">
            <span
                class="flex items-center gap-2 px-2 py-1 bg-green-500 text-white rounded-full border-2 border-green-800 shadow-md">üö©
                <span id="levelDisplay">1</span></span>
            <span
                class="flex items-center gap-2 px-2 py-1 bg-yellow-500 text-white rounded-full border-2 border-yellow-800 shadow-md">üèÜ
                <span id="scoreDisplay">0</span></span>
            <span
                class="flex items-center gap-2 px-2 py-1 bg-red-500 text-white rounded-full border-2 border-red-800 shadow-md">‚ù§Ô∏è
                <span id="livesDisplay">5</span></span>
            <span
                class="flex items-center gap-2 px-2 py-1 bg-blue-500 text-white rounded-full border-2 border-blue-800 shadow-md">‚è±Ô∏è
                <span id="timeDisplay">100</span>s</span>
        </div>

        <canvas id="gameCanvas" width="800" height="450"></canvas>

        <!-- Skrin Daftar Nama -->
        <div id="registerScreen" class="overlay title-screen">
            <h1 class="jungle-title">RENJER<br>JOHOR</h1>
            <div class="jungle-panel mx-4">
                <h2 class="text-3xl font-black text-gray-800 mb-4">Sila Masukkan Nama</h2>
                <!-- TOP 3 -->
                <div id="top3Container"
                    class="bg-gray-800 text-white rounded p-3 mb-4 shadow mx-auto max-w-sm hidden border border-yellow-600">
                    <p class="text-yellow-400 font-bold mb-2">üèÜ Carta 3 Teratas :</p>
                    <div id="top3List" class="text-sm font-semibold text-left mx-6 leading-relaxed"></div>
                </div>
                <!-- END TOP 3 -->
                <p class="text-gray-700 font-bold mb-6">Sila masukkan nama anda sebagai rekod pengembaraan.</p>
                <input type="text" id="playerNameInput" placeholder="Nama Renjer (Contoh: Ali)" maxlength="15"
                    class="w-full border-4 border-yellow-800 rounded-lg p-3 text-black text-xl mb-4 text-center focus:outline-none focus:ring-4 focus:ring-yellow-500 font-bold"
                    style="background-color: #FDF5E6;">
                <button id="submitNameBtn" class="jungle-btn mb-4 flex justify-center items-center gap-2">
                    ‚ñ∂Ô∏è Daftar & Mula
                </button>
                <button id="openLeaderboardBtn"
                    class="jungle-btn jungle-btn-blue mb-4 flex justify-center items-center gap-2">
                    üèÜ Papan Markah
                </button>
                <button id="openAdminLoginBtn"
                    class="text-sm text-green-700 hover:text-green-900 underline font-extrabold mt-2 flex justify-center items-center gap-1 mx-auto">
                    ‚öôÔ∏è Log Masuk Super Admin
                </button>
            </div>
        </div>

        <!-- Skrin Log Masuk Admin -->
        <div id="adminLoginScreen" class="overlay title-screen hidden">
            <div class="jungle-panel mx-4">
                <h2 class="text-2xl font-black text-green-800 mb-6">‚öôÔ∏è Akses Super Admin</h2>
                <input type="text" id="adminUsername" placeholder="ID Admin"
                    class="w-full border-4 border-yellow-800 rounded-lg p-3 text-black text-lg mb-4 text-center focus:outline-none font-bold"
                    style="background-color: #FDF5E6;">
                <input type="password" id="adminPassword" placeholder="Kata Laluan"
                    class="w-full border-4 border-yellow-800 rounded-lg p-3 text-black text-lg mb-6 text-center focus:outline-none font-bold"
                    style="background-color: #FDF5E6;">
                <button id="adminLoginSubmitBtn"
                    class="jungle-btn jungle-btn-blue mb-4 flex justify-center items-center gap-2">
                    ‚úîÔ∏è Log Masuk
                </button>
                <button id="adminLoginBackBtn" class="jungle-btn jungle-btn-red flex justify-center items-center gap-2">
                    ‚¨ÖÔ∏è Kembali
                </button>
            </div>
        </div>

        <!-- Skrin Papan Pemuka Admin -->
        <div id="adminDashboardScreen" class="overlay hidden">
            <div
                class="bg-white p-6 rounded-xl text-center max-w-4xl w-[95%] mx-4 shadow-2xl border-4 border-blue-600 flex flex-col h-[90vh]">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-blue-800">Papan Pemuka Super Admin</h2>
                    <button id="adminLogoutBtn"
                        class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded transition">Log
                        Keluar</button>
                </div>

                <!-- Senarai Soalan (3 Kolum) -->
                <div
                    class="flex-grow overflow-y-auto mb-4 p-2 bg-gray-200 border-2 border-gray-400 rounded-lg shadow-inner flex flex-col md:flex-row gap-4 h-[40vh]">
                    <!-- Mudah -->
                    <div class="flex-1 bg-white p-3 rounded shadow border-t-4 border-green-500 overflow-y-auto">
                        <h3 class="font-bold text-green-700 border-b-2 border-gray-100 mb-3 pb-2 sticky top-0 bg-white">
                            üü© Mudah (Tahap 1-3)</h3>
                        <div id="adminListMudah" class="space-y-3 text-left"></div>
                    </div>
                    <!-- Sederhana -->
                    <div class="flex-1 bg-white p-3 rounded shadow border-t-4 border-yellow-500 overflow-y-auto">
                        <h3
                            class="font-bold text-yellow-600 border-b-2 border-gray-100 mb-3 pb-2 sticky top-0 bg-white">
                            üü® Sederhana (Tahap 4-5)</h3>
                        <div id="adminListSederhana" class="space-y-3 text-left"></div>
                    </div>
                    <!-- Sukar -->
                    <div class="flex-1 bg-white p-3 rounded shadow border-t-4 border-red-500 overflow-y-auto">
                        <h3 class="font-bold text-red-600 border-b-2 border-gray-100 mb-3 pb-2 sticky top-0 bg-white">üü•
                            Sukar (Level Bos)</h3>
                        <div id="adminListSukar" class="space-y-3 text-left"></div>
                    </div>
                </div>

                <!-- Tambah Soalan Baru -->
                <div class="bg-blue-100 p-4 rounded-lg text-left mt-2 border-2 border-blue-300">
                    <div class="flex justify-between items-center mb-3 border-b-2 border-blue-300 pb-2">
                        <h3 class="text-md font-bold text-blue-800">‚ûï Tambah Soalan Baharu</h3>
                        <!-- JANA AI BUTTON -->
                        <button id="aiGenBtn"
                            class="bg-purple-600 hover:bg-purple-800 text-white px-4 py-1.5 rounded text-xs font-bold transition flex items-center gap-1 shadow-md border-2 border-purple-900">
                            ‚ú® Jana AI (Auto-Isi)
                        </button>
                    </div>
                    <input type="text" id="newQuestion" placeholder="Masukkan Soalan (atau klik Butang Jana AI)"
                        class="w-full p-2 mb-2 border rounded text-black text-sm">

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mb-2">
                        <input type="text" id="newOpt0" placeholder="Pilihan 1"
                            class="w-full p-2 border rounded text-black text-sm border-gray-300">
                        <input type="text" id="newOpt1" placeholder="Pilihan 2"
                            class="w-full p-2 border rounded text-black text-sm border-gray-300">
                        <input type="text" id="newOpt2" placeholder="Pilihan 3"
                            class="w-full p-2 border rounded text-black text-sm border-gray-300">
                    </div>

                    <div class="flex gap-4 items-center">
                        <div class="flex-1">
                            <label class="text-sm font-semibold text-gray-700">Jawapan Betul:</label>
                            <select id="newAnswer" class="w-full p-2 border rounded text-black text-sm mt-1">
                                <option value="0">Pilihan 1</option>
                                <option value="1">Pilihan 2</option>
                                <option value="2">Pilihan 3</option>
                            </select>
                        </div>
                        <div class="flex-1">
                            <label class="text-sm font-semibold text-gray-700">Tahap Kesukaran:</label>
                            <select id="newDiff" class="w-full p-2 border rounded text-black text-sm mt-1">
                                <option value="1">1 - Mudah (Tahap 1-3)</option>
                                <option value="2">2 - Sederhana (Tahap 4-5)</option>
                                <option value="3">3 - Sukar (Tahap 6)</option>
                            </select>
                        </div>
                        <button id="addQuestionBtn"
                            class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded mt-6 h-10 transition">
                            Simpan
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Skrin Papan Markah Leaderboard -->
        <div id="leaderboardScreen" class="overlay title-screen hidden">
            <div class="jungle-panel mx-4" style="max-width: 600px; width: 95%;">
                <h2 class="text-3xl font-black text-yellow-600 mb-4 drop-shadow-md">üèÜ Papan Markah (Top 10)</h2>

                <div class="admin-table-container mb-4" style="max-height: 300px;">
                    <table class="admin-table text-lg">
                        <thead>
                            <tr>
                                <th width="15%" class="text-center">#</th>
                                <th width="50%">Renjer</th>
                                <th width="35%" class="text-center">Markah</th>
                            </tr>
                        </thead>
                        <tbody id="leaderboardList">
                            <!-- Diisi oleh JS -->
                        </tbody>
                    </table>
                </div>

                <div class="flex gap-4 justify-center">
                    <button id="leaderboardBackBtn" class="jungle-btn jungle-btn-red px-8 py-2">
                        ‚¨ÖÔ∏è Kembali
                    </button>
                </div>
            </div>
        </div>

        <!-- Skrin Menu Utama -->
        <div id="startScreen" class="overlay title-screen hidden">
            <h1 class="jungle-title" style="font-size: clamp(2rem, 5vw, 4rem); margin-bottom: 1rem;">RENJER JOHOR</h1>
            <div class="jungle-panel mx-4 max-w-lg">
                <h1 class="text-3xl font-black text-green-700 mb-2 text-center">Selamat Datang,<br><span
                        id="displayPlayerName" class="text-red-600"></span>!</h1>
                <h2 class="text-xl font-bold mb-4 text-gray-700">Bersedia untuk 6 Tahap Misi Taman Negara</h2>

                <div class="bg-yellow-50 border-4 border-yellow-300 p-4 rounded-lg text-left mb-6 shadow-inner">
                    <p class="mb-2 text-green-900">üéÆ <strong>Cara Bermain & Halangan:</strong></p>
                    <ul class="text-sm text-gray-800 list-disc pl-5 space-y-1 font-medium">
                        <li>Gunakan panah kiri/kanan & Spacebar untuk lompat (Boleh <strong>Lompat 2 Kali</strong>).
                        </li>
                        <li>Hati-hati dengan masa. Masa tamat = Hilang nyawa.</li>
                        <li>Lompat <strong>ATAS KEPALA</strong> haiwan liar untuk menewaskannya.</li>
                        <li class="text-red-600">‚ö†Ô∏è <strong>Tahap 4+:</strong> Pemburu Haram menembak api ungu!</li>
                        <li class="text-orange-600">üî• <strong>Tahap 4+:</strong> Tekan "Z" atau butang Api
                            untuk tembak musuh!</li>
                    </ul>
                </div>

                <button id="startBtn" class="jungle-btn">
                    ‚ñ∂Ô∏è Mula Permainan
                </button>
            </div>
        </div>

        <!-- Skrin Soalan Trivia -->
        <div id="triviaScreen" class="overlay hidden">
            <div class="bg-white text-black p-8 rounded-xl max-w-lg w-[90%] mx-4 shadow-2xl border-4 border-green-500">
                <div class="flex items-center mb-4">
                    <div
                        class="bg-blue-500 text-white rounded-full w-10 h-10 flex justify-center items-center font-bold text-xl mr-3">
                        ?</div>
                    <h2 class="text-2xl font-bold text-blue-700">Trivia Taman Negara</h2>
                </div>
                <p id="questionText" class="text-lg mb-6 font-medium"></p>
                <div id="answersContainer" class="flex flex-col gap-3"></div>
            </div>
        </div>

        <!-- Skrin Menang/Kalah -->
        <div id="endScreen" class="overlay hidden">
            <h1 id="endTitle" class="text-5xl font-bold mb-2 text-center">Tamat</h1>
            <p id="endMessage" class="text-2xl mb-4 text-center">Anda telah...</p>

            <!-- Box Markah & Kedudukan -->
            <div
                class="bg-gray-800 p-6 rounded-xl border border-gray-600 mb-6 flex flex-col items-center w-72 shadow-xl">
                <p class="text-lg text-gray-300 mb-1">Markah Terkumpul:</p>
                <p class="text-5xl font-black text-yellow-400 drop-shadow-md" id="finalScore">0</p>

                <div id="rankContainer" class="mt-4 pt-4 border-t border-gray-600 w-full text-center hidden">
                    <p class="text-sm text-gray-400">Kedudukan Semasa Anda:</p>
                    <p class="text-2xl font-bold text-green-400 mt-1" id="finalRank">Tangga #1</p>
                </div>
            </div>
            <div class="flex flex-col gap-3">
                <button id="nextLevelBtn" class="hidden jungle-btn mb-3 flex justify-center items-center gap-2">
                    Maju Ke Tahap Seterusnya ‚û°Ô∏è
                </button>
                <button id="restartBtn" class="jungle-btn jungle-btn-blue flex justify-center items-center gap-2">
                    üè† Kembali ke Menu Utama
                </button>
            </div>
        </div>

        <!-- Skrin Interstitial (Gambar) -->
        <div id="interstitialScreen"
            class="overlay hidden bg-green-900 bg-opacity-95 flex flex-col justify-center items-center">
            <h2 class="text-5xl font-black text-white mb-6 text-center drop-shadow-lg">Tahniah <span
                    id="interstitialNameDisplay" class="text-yellow-400"></span>!</h2>
            <img src="" alt="Lokasi Taman Negara"
                class="opacity-0 max-w-[90%] max-h-[60vh] object-contain cursor-pointer transition transform hover:scale-105"
                id="interstitialImg">
            <button id="interstitialNextBtn"
                class="bg-green-500 hover:bg-green-600 text-white rounded-full p-4 mt-8 shadow-lg transform transition hover:scale-110 border-4 border-green-800 animate-bounce">
                <span class="text-4xl px-2">‚ñ∂Ô∏è</span>
            </button>
        </div>

        <!-- Kawalan Sentuh -->
        <div id="touch-controls" class="hidden">
            <div class="dir-buttons">
                <div class="btn-touch" id="btnLeft">‚¨ÖÔ∏è</div>
                <div class="btn-touch" id="btnRight">‚û°Ô∏è</div>
            </div>
            <div class="dir-buttons">
                <div class="btn-touch hidden" id="btnShoot"
                    style="background: rgba(221, 107, 32, 0.5); border-color: #FBD38D;">üî•</div>
                <div class="btn-touch" id="btnJump">‚¨ÜÔ∏è</div>
            </div>
        </div>
    </div>

    <!-- SUPABASE SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script type="module">
        const DB_URL = "https://pfazkzdsfezjkcupnmjb.supabase.co";
        const DB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBmYXpremRzZmV6amtjdXBubWpiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIyNjIyMDYsImV4cCI6MjA4NzgzODIwNn0.YOFakezR0VvuzST-26Q1-aps_c_JZ1YnqB2nAmVB96A";
        let supabaseClient;

        try {
            if (window.supabase) supabaseClient = window.supabase.createClient(DB_URL, DB_KEY);
        } catch (e) { console.error("Global supabase import error:", e); }

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        const screens = {
            register: document.getElementById('registerScreen'),
            adminLogin: document.getElementById('adminLoginScreen'),
            adminDash: document.getElementById('adminDashboardScreen'),
            start: document.getElementById('startScreen'),
            trivia: document.getElementById('triviaScreen'),
            end: document.getElementById('endScreen'),
            interstitial: document.getElementById('interstitialScreen'),
            leaderboard: document.getElementById('leaderboardScreen')
        };
        const scoreDisplay = document.getElementById('scoreDisplay');
        const livesDisplay = document.getElementById('livesDisplay');
        const levelDisplay = document.getElementById('levelDisplay');
        const timeDisplay = document.getElementById('timeDisplay');
        const touchControls = document.getElementById('touch-controls');
        const btnShoot = document.getElementById('btnShoot');

        let gameState = 'REGISTER';
        let playerName = "";
        let score = 0;
        let lives = 5;
        let currentLevel = 1;
        let cameraX = 0;
        let levelWidth = 3000;
        let theme = 'gunung';

        let timeLeft = 100;
        let lastTimeTick = Date.now();

        let usedQuestions = [];

        let fireballs = [];
        let enemyFireballs = [];
        let lastShootTime = 0;

        // KREDENSIAL SUPER ADMIN LALAI (Default)
        const ADMIN_USER = "ptnj";
        const ADMIN_PASS = "johor2025";

        const defaultTriviaDB = [
            // TAHAP 1-3 (Mudah) - diff: 1
            { q: "Gunung Ledang merupakan gunung tertinggi di negeri mana?", options: ["Melaka", "Johor", "Pahang"], answer: 1, diff: 1 },
            { q: "Siapakah agensi yang menjaga Taman Negara Johor?", options: ["Jabatan Perhutanan", "PTNJ", "PERHILITAN"], answer: 1, diff: 1 },
            { q: "Apakah lagenda terkenal yang dikaitkan dengan Gunung Ledang?", options: ["Mahsuri", "Puteri Santubong", "Puteri Gunung Ledang"], answer: 2, diff: 1 },
            { q: "Tanjung Piai terkenal sebagai?", options: ["Titik Paling Utara Asia", "Penghujung Selatan Benua Asia", "Pulau Terbesar"], answer: 1, diff: 1 },
            { q: "Apakah haiwan ikonik Taman Negara Endau-Rompin?", options: ["Orang Utan", "Harimau Malaya", "Beruang Panda"], answer: 1, diff: 1 },
            { q: "Daerah manakah letaknya Gunung Ledang?", options: ["Muar", "Tangkak", "Segamat"], answer: 1, diff: 1 },

            // TAHAP 4-5 (Sederhana) - diff: 2
            { q: "Pulau Kukup memegang status sebagai pulau bakau tidak berpenghuni yang keberapa terbesar di dunia?", options: ["Pertama", "Kedua", "Ketiga"], answer: 1, diff: 2 },
            { q: "Apakah kumpulan Orang Asli utama yang menetap di Endau-Rompin (Peta)?", options: ["Semang", "Jakun", "Senoi"], answer: 1, diff: 2 },
            { q: "Spesies pokok kipas gergasi kuno endemik di Endau-Rompin dipanggil?", options: ["Rafflesia", "Livistona endauensis", "Pokok Cengal"], answer: 1, diff: 2 },
            { q: "Tanjung Piai dan Pulau Kukup telah diiktiraf sebagai Tapak?", options: ["Tapak Ramsar", "Tapak UNESCO", "Tapak Warisan Bersejarah"], answer: 0, diff: 2 },
            { q: "Berapakah bilangan pulau utama dalam gugusan Taman Laut Sultan Iskandar?", options: ["5 Pulau", "13 Pulau", "25 Pulau"], answer: 1, diff: 2 },
            { q: "Paya bakau memainkan peranan penting dalam alam sekitar sebagai...", options: ["Punca air minuman", "Melindungi pantai dari hakisan", "Tempat melombong pasir"], answer: 1, diff: 2 },

            // TAHAP 6 (Sangat Sukar) - diff: 3
            { q: "Spesies kera apakah yang banyak mendiami kawasan bakau Pulau Kukup?", options: ["Kera Bekantan", "Kera Ekor Panjang (Macaque)", "Cimpanzi"], answer: 1, diff: 3 },
            { q: "Apakah status flora dan fauna dalam semua Taman Negara?", options: ["Boleh diburu", "Dilindungi sepenuhnya oleh undang-undang", "Tanggungjawab penduduk"], answer: 1, diff: 3 },
            { q: "Pulau Kukup merupakan pulau yang terbentuk sepenuhnya daripada?", options: ["Pasir Pantai", "Lumpur dan Hutan Bakau", "Batu Karang"], answer: 1, diff: 3 },
            { q: "Umur dianggarkan bagi pembentukan batuan di Hutan Endau-Rompin?", options: ["50 Juta Tahun", "240 Juta Tahun", "1 Bilion Tahun"], answer: 1, diff: 3 },
            { q: "Apakah nama saintifik bagi pokok periuk kera yang terdapat di kawasan Gunung Ledang?", options: ["Hibiscus rosa-sinensis", "Nepenthes", "Rafflesia arnoldii"], answer: 1, diff: 3 },
            { q: "Berapakah jumlah anggaran keluasan Taman Negara Endau-Rompin (Peta & Selai)?", options: ["10,000 hektar", "40,000 hektar", "80,000 hektar"], answer: 2, diff: 3 }
        ];

        let triviaDB = [...defaultTriviaDB]; // Temporary default while loading

        async function loadTriviaDB() {
            if (!supabaseClient) return;
            try {
                const { data, error } = await supabaseClient.from('ptnj_trivia').select('*');
                if (data && data.length > 0) {
                    triviaDB = data;
                } else if (error) {
                    console.warn("Supabase Warning Loading Trivia:", error.message);
                    triviaDB = [...defaultTriviaDB]; // Fallback if table doesn't exist
                }
            } catch (e) {
                console.error("Network Error Loading Trivia:", e);
                triviaDB = [...defaultTriviaDB]; // Fallback
            }
        }

        async function saveTriviaDB(newDataObject) {
            if (!supabaseClient) return;
            try {
                if (newDataObject) {
                    await supabaseClient.from('ptnj_trivia').insert([newDataObject]);
                }
            } catch (e) { console.error("Error saving Question:", e); }
        }

        window.removeTriviaDB = async function (id) {
            if (!supabaseClient) return;
            try {
                await supabaseClient.from('ptnj_trivia').delete().eq('id', id);
            } catch (e) { console.error("Error deleting Question:", e); }
        }

        // --- PENGURUSAN PAPAN MARKAH (LEADERBOARD) ---
        let currentRank = -1;

        async function saveHighScoreAsync(name, markah) {
            if (markah <= 0 || !supabaseClient) return;
            const newRecord = { name: name || "Renjer Tanpa Nama", score: markah, date: new Date().toLocaleDateString() };

            try {
                // Hantar rekod baharu ke Supabase
                await supabaseClient.from('ptnj_leaderboard').insert([newRecord]);

                // Ambil balik semua rekod untuk kira kedudukan (Real-time live rank)
                const { data, error } = await supabaseClient.from('ptnj_leaderboard')
                    .select('id, name, score, date')
                    .order('score', { ascending: false });

                if (data) {
                    // Cari kedudukan terkini rekod tadi
                    currentRank = data.findIndex(r => r.name === newRecord.name && r.score === newRecord.score);
                    showEndRank(currentRank);
                }
            } catch (e) { console.error("Error saving High Score:", e); }
        }

        document.getElementById('openLeaderboardBtn').addEventListener('click', async () => {
            hideAllScreens();

            const tbody = document.getElementById('leaderboardList');
            tbody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-gray-500 font-bold">Sedang memuat turun data secara live...</td></tr>';

            document.getElementById('leaderboardScreen').classList.remove('hidden');

            if (!supabaseClient) {
                tbody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-red-500 font-bold">Client database tidak wujud.</td></tr>';
                return;
            }

            try {
                const { data: board, error } = await supabaseClient.from('ptnj_leaderboard')
                    .select('*')
                    .order('score', { ascending: false })
                    .limit(10);

                tbody.innerHTML = '';

                if (!board || board.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-gray-500 font-bold">Belum ada rekod. Jadilah yang pertama!</td></tr>';
                } else {
                    board.forEach((entry, idx) => {
                        let medal = idx === 0 ? 'ü•á' : idx === 1 ? 'ü•à' : idx === 2 ? 'ü•â' : `${idx + 1}`;
                        let rowHtml = `<tr class="border-b border-gray-200">
                            <td class="text-center font-black">${medal}</td>
                            <td class="font-bold text-gray-800">${entry.name} <span class="text-xs text-gray-400 block">${entry.date}</span></td>
                            <td class="text-center font-black text-green-700">${entry.score}</td>
                        </tr>`;
                        tbody.insertAdjacentHTML('beforeend', rowHtml);
                    });
                }
            } catch (e) {
                tbody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-red-500 font-bold">Gagal menyambung ke pangkalan data awan.</td></tr>';
            }
        });

        document.getElementById('leaderboardBackBtn').addEventListener('click', () => {
            hideAllScreens();
            screens.register.classList.remove('hidden');
        });
        // --- TAMAT PENGURUSAN PAPAN MARKAH ---

        let currentTriviaBlock = null;

        // --- FUNGSI SUPER ADMIN ---
        function renderAdminQuestions() {
            const list1 = document.getElementById('adminListMudah');
            const list2 = document.getElementById('adminListSederhana');
            const list3 = document.getElementById('adminListSukar');
            list1.innerHTML = ''; list2.innerHTML = ''; list3.innerHTML = '';

            triviaDB.forEach((q, idx) => {
                let optsText = `<div class="ml-2 mt-2 -space-y-1 text-xs">
                <span class="${q.answer === 0 ? 'bg-green-200 text-green-900 font-bold px-1 rounded inline-block mb-1' : 'text-gray-600 block mb-1'}">A) ${q.options[0]}</span><br>
                <span class="${q.answer === 1 ? 'bg-green-200 text-green-900 font-bold px-1 rounded inline-block mb-1' : 'text-gray-600 block mb-1'}">B) ${q.options[1]}</span><br>
                <span class="${q.answer === 2 ? 'bg-green-200 text-green-900 font-bold px-1 rounded inline-block mb-1' : 'text-gray-600 block mb-1'}">C) ${q.options[2]}</span>
                </div>`;

                const card = document.createElement('div');
                card.className = "bg-gray-50 border border-gray-300 p-3 rounded-lg relative hover:shadow-md transition";
                card.innerHTML = `
                    <p class="font-bold text-gray-900 text-sm leading-snug w-[85%]">${idx + 1}. ${q.q}</p>
                    ${optsText}
                    <button onclick="deleteQuestion(${idx}, ${q.id})" title="Padam Soalan" class="absolute top-2 right-2 bg-red-100 hover:bg-red-500 text-red-700 hover:text-white border border-red-300 rounded text-xs px-2 py-1 transition font-bold">X</button>
                `;

                if (q.diff === 1) list1.appendChild(card);
                else if (q.diff === 2) list2.appendChild(card);
                else list3.appendChild(card);
            });
        }

        window.deleteQuestion = async function (idx, dbId) {
            if (confirm("Adakah anda pasti mahu memadam soalan ini? Ini akan memadamkannya dari server pangkalan data awam.")) {
                triviaDB.splice(idx, 1);
                renderAdminQuestions();
                if (dbId) await removeTriviaDB(dbId);
            }
        };

        document.getElementById('addQuestionBtn').addEventListener('click', async () => {
            const qText = document.getElementById('newQuestion').value.trim();
            const opt0 = document.getElementById('newOpt0').value.trim();
            const opt1 = document.getElementById('newOpt1').value.trim();
            const opt2 = document.getElementById('newOpt2').value.trim();
            const ans = parseInt(document.getElementById('newAnswer').value);
            const diff = parseInt(document.getElementById('newDiff').value);

            if (!qText || !opt0 || !opt1 || !opt2) {
                alert("Sila lengkapkan semua medan soalan dan pilihan jawapan!");
                return;
            }

            const payload = { q: qText, options: [opt0, opt1, opt2], answer: ans, diff: diff };
            // Optimistic UI mapping
            triviaDB.push(payload);
            renderAdminQuestions();

            document.getElementById('addQuestionBtn').innerText = "Menyimpan...";
            document.getElementById('addQuestionBtn').disabled = true;

            await saveTriviaDB(payload);
            await loadTriviaDB(); // Ambil balik soalan yang dah ada auto-increment ID
            renderAdminQuestions(); // Render semula dengan ID rasmi

            document.getElementById('addQuestionBtn').innerText = "Simpan";
            document.getElementById('addQuestionBtn').disabled = false;

            // Clear forms
            document.getElementById('newQuestion').value = '';
            document.getElementById('newOpt0').value = '';
            document.getElementById('newOpt1').value = '';
            document.getElementById('newOpt2').value = '';

            renderAdminQuestions();
            alert("Soalan baharu berjaya ditambah!");
        });

        document.getElementById('openAdminLoginBtn').addEventListener('click', () => {
            hideAllScreens();
            screens.adminLogin.classList.remove('hidden');
            gameState = 'ADMIN_LOGIN';
        });

        document.getElementById('adminLoginBackBtn').addEventListener('click', () => {
            hideAllScreens();
            screens.register.classList.remove('hidden');
            gameState = 'REGISTER';
        });

        document.getElementById('adminLoginSubmitBtn').addEventListener('click', () => {
            const u = document.getElementById('adminUsername').value;
            const p = document.getElementById('adminPassword').value;
            if (u === ADMIN_USER && p === ADMIN_PASS) {
                document.getElementById('adminUsername').value = '';
                document.getElementById('adminPassword').value = '';
                hideAllScreens();
                try {
                    if (!triviaDB || triviaDB.length === 0) triviaDB = [...defaultTriviaDB];
                    renderAdminQuestions();
                } catch (e) {
                    console.error("Error rendering admin panel:", e);
                }
                screens.adminDash.classList.remove('hidden');
            } else {
                alert("ID Admin atau Kata Laluan SALAH!");
            }
        });

        document.getElementById('adminLogoutBtn').addEventListener('click', () => {
            hideAllScreens();
            screens.register.classList.remove('hidden');
            gameState = 'REGISTER';
        });
        // --- TAMAT FUNGSI ADMIN ---

        const keys = { right: false, left: false, up: false };

        function performJump() {
            if (player.jumpCount < player.maxJumps) {
                player.vy = player.jumpPower;
                player.jumpCount++;
                player.grounded = false;
            }
        }

        window.addEventListener('keydown', (e) => {
            if (gameState !== 'PLAYING') return;
            if (e.code === 'ArrowRight' || e.code === 'KeyD') keys.right = true;
            if (e.code === 'ArrowLeft' || e.code === 'KeyA') keys.left = true;
            if (e.code === 'ArrowUp' || e.code === 'Space' || e.code === 'KeyW') {
                keys.up = true;
                performJump();
            }
            if (e.code === 'KeyZ') shootFireball();
        });

        window.addEventListener('keyup', (e) => {
            if (e.code === 'ArrowRight' || e.code === 'KeyD') keys.right = false;
            if (e.code === 'ArrowLeft' || e.code === 'KeyA') keys.left = false;
            if (e.code === 'ArrowUp' || e.code === 'Space' || e.code === 'KeyW') keys.up = false;
        });

        const btnLeft = document.getElementById('btnLeft');
        const btnRight = document.getElementById('btnRight');
        const btnJump = document.getElementById('btnJump');

        const addTouch = (elem, key, isJump = false) => {
            elem.addEventListener('touchstart', (e) => {
                e.preventDefault();
                if (gameState === 'PLAYING') {
                    if (isJump) performJump();
                    else keys[key] = true;
                }
            });
            elem.addEventListener('touchend', (e) => {
                e.preventDefault();
                if (!isJump) keys[key] = false;
            });
        };
        addTouch(btnLeft, 'left');
        addTouch(btnRight, 'right');
        addTouch(btnJump, 'up', true);

        btnShoot.addEventListener('touchstart', (e) => {
            e.preventDefault();
            if (gameState === 'PLAYING') shootFireball();
        });

        if ('ontouchstart' in window || navigator.maxTouchPoints > 0) touchControls.classList.remove('hidden');

        const player = {
            x: 50, y: 200, width: 40, height: 60,
            vx: 0, vy: 0, speed: 5,
            jumpPower: -13, maxJumps: 2, jumpCount: 0,
            gravity: 0.6, grounded: false,
            color: '#2F855A', facingLeft: false
        };

        function shootFireball() {
            if (currentLevel < 4) return;
            let now = Date.now();
            if (now - lastShootTime < 500) return;
            lastShootTime = now;

            fireballs.push({
                x: player.facingLeft ? player.x - 20 : player.x + player.width,
                y: player.y + player.height / 2 - 10,
                width: 20, height: 20,
                vx: player.facingLeft ? -10 : 10
            });
        }

        let platforms = [], coins = [], trivias = [], hazards = [], enemies = [];
        let goal = { x: 0, y: 0, width: 60, height: 100 };

        function buildLevel(level) {
            platforms = []; coins = []; trivias = []; hazards = []; enemies = [];
            enemyFireballs = [];

            if (level <= 2) theme = 'gunung';
            else if (level <= 4) theme = 'hutan';
            else theme = 'bakau';

            timeLeft = 80 + (level * 20);
            lastTimeTick = Date.now();

            levelWidth = 3000 + (level * 500);
            let enemyBaseSpeed = 1.0 + (level * 0.2);
            let fireSpawnChance = 0.15 + (level * 0.05);

            let curX = 0;
            platforms.push({ x: curX, y: 400, width: 500, height: 50, type: 'ground' });
            curX += 500;

            let triviaPlaced = 0;

            let animalTypes = [];
            if (theme === 'gunung') animalTypes = ['monyet', 'burung'];
            else if (theme === 'hutan') animalTypes = ['harimau', 'gajah', 'monyet', 'burung'];
            else animalTypes = ['burung', 'monyet', 'harimau'];

            if (level >= 4) {
                animalTypes.push('pemburu', 'pemburu');
            }

            while (curX < levelWidth - 800) {
                let gap = 80 + Math.random() * (40 + (level * 8));
                if (gap > 220) gap = 220;

                hazards.push({ x: curX, y: 420, width: gap, height: 30 });
                curX += gap;

                let platW = 200 + Math.random() * 400;
                platforms.push({ x: curX, y: 400, width: platW, height: 50, type: 'ground' });

                if (Math.random() < 0.6 + (level * 0.05)) {
                    let eType = Math.random() < fireSpawnChance ? 'fire' : animalTypes[Math.floor(Math.random() * animalTypes.length)];
                    let eObj = { type: eType, active: true };

                    if (eType === 'gajah') {
                        eObj.width = 70; eObj.height = 45; eObj.vx = enemyBaseSpeed * 0.5; eObj.minX = curX; eObj.maxX = curX + platW;
                    } else if (eType === 'harimau') {
                        eObj.width = 60; eObj.height = 30; eObj.vx = enemyBaseSpeed * 1.5; eObj.minX = curX; eObj.maxX = curX + platW;
                    } else if (eType === 'monyet') {
                        eObj.width = 30; eObj.height = 30; eObj.vx = enemyBaseSpeed; eObj.vy = 0; eObj.minX = curX; eObj.maxX = curX + platW;
                    } else if (eType === 'burung') {
                        eObj.width = 30; eObj.height = 20; eObj.vx = -enemyBaseSpeed * 1.5; eObj.startY = 150 + Math.random() * 100;
                        eObj.minX = -1000; eObj.maxX = levelWidth + 1000;
                    } else if (eType === 'pemburu') {
                        eObj.width = 40; eObj.height = 60; eObj.vx = enemyBaseSpeed * 0.8; eObj.minX = curX; eObj.maxX = curX + platW;
                        eObj.lastShoot = Date.now() + Math.random() * 2000;
                    } else {
                        eObj.width = 30; eObj.height = 30; eObj.type = 'fire';
                    }

                    eObj.x = eType === 'fire' ? curX + platW / 2 : curX + 20;
                    eObj.y = eType === 'burung' ? eObj.startY : 400 - eObj.height;

                    enemies.push(eObj);
                }

                if (Math.random() > 0.4) {
                    platforms.push({ x: curX + platW / 4, y: 250 - (Math.random() * 50), width: 120, height: 20, type: 'platform' });
                    coins.push({ x: curX + platW / 4 + 60, y: 210, radius: 10, collected: false });

                    if (triviaPlaced < 3 && Math.random() > 0.5) {
                        trivias.push({ x: curX + platW / 4 + 40, y: 190, width: 40, height: 60, active: true });
                        triviaPlaced++;
                    }
                }
                curX += platW;
            }

            while (triviaPlaced < 3) {
                trivias.push({ x: curX - 300 - (triviaPlaced * 100), y: 340, width: 40, height: 60, active: true });
                triviaPlaced++;
            }

            platforms.push({ x: curX, y: 400, width: 800, height: 50, type: 'ground' });
            goal = { x: curX + 400, y: 250, width: 60, height: 100 };
        }

        function drawBackground() {
            if (theme === 'gunung') {
                let grad = ctx.createLinearGradient(0, 0, 0, canvas.height);
                grad.addColorStop(0, '#87CEEB'); grad.addColorStop(1, '#E0F6FF');
                ctx.fillStyle = grad; ctx.fillRect(0, 0, canvas.width, canvas.height);

                ctx.fillStyle = '#68D391'; ctx.beginPath(); ctx.moveTo(0 - cameraX * 0.1, 400); ctx.lineTo(300 - cameraX * 0.1, 100); ctx.lineTo(600 - cameraX * 0.1, 400); ctx.fill();
                ctx.fillStyle = '#48BB78'; ctx.beginPath(); ctx.moveTo(400 - cameraX * 0.2, 400); ctx.lineTo(700 - cameraX * 0.2, 150); ctx.lineTo(1000 - cameraX * 0.2, 400); ctx.fill();
            }
            else if (theme === 'hutan') {
                let grad = ctx.createLinearGradient(0, 0, 0, canvas.height);
                grad.addColorStop(0, '#276749'); grad.addColorStop(1, '#9AE6B4');
                ctx.fillStyle = grad; ctx.fillRect(0, 0, canvas.width, canvas.height);

                ctx.fillStyle = '#744210';
                for (let i = 0; i < 10; i++) ctx.fillRect((i * 300) - cameraX * 0.2, 50, 40, 350);
            }
            else if (theme === 'bakau') {
                let grad = ctx.createLinearGradient(0, 0, 0, canvas.height);
                grad.addColorStop(0, '#ED8936'); grad.addColorStop(1, '#FEEBC8');
                ctx.fillStyle = grad; ctx.fillRect(0, 0, canvas.width, canvas.height);

                ctx.fillStyle = '#9C4221';
                for (let i = 0; i < 15; i++) {
                    ctx.beginPath(); let bx = (i * 200) - cameraX * 0.15;
                    ctx.moveTo(bx, 400); ctx.lineTo(bx + 30, 250); ctx.lineTo(bx + 60, 400); ctx.fill();
                }
            }
        }

        function updatePhysics() {
            let now = Date.now();
            if (now - lastTimeTick >= 1000) {
                timeLeft--;
                lastTimeTick = now;
                updateHUD();
                if (timeLeft <= 10) timeDisplay.classList.add('text-red');
                else timeDisplay.classList.remove('text-red');
                if (timeLeft <= 0) { loseLife(); return; }
            }

            if (keys.left) { player.vx = -player.speed; player.facingLeft = true; }
            else if (keys.right) { player.vx = player.speed; player.facingLeft = false; }
            else { player.vx *= 0.8; }

            player.vy += player.gravity;
            if (player.vy > 12) player.vy = 12;

            player.x += player.vx;
            if (player.x < 0) player.x = 0;

            for (let p of platforms) {
                if (checkCollision(player, p)) {
                    if (player.vx > 0) { player.x = p.x - player.width; player.vx = 0; }
                    else if (player.vx < 0) { player.x = p.x + p.width; player.vx = 0; }
                }
            }

            player.y += player.vy;
            player.grounded = false;

            for (let p of platforms) {
                if (checkCollision(player, p)) {
                    if (player.vy > 0) {
                        player.y = p.y - player.height; player.vy = 0;
                        player.grounded = true; player.jumpCount = 0;
                    } else if (player.vy < 0) {
                        player.y = p.y + p.height; player.vy = 0;
                    }
                }
            }

            cameraX = player.x - canvas.width / 2 + player.width / 2;
            if (cameraX < 0) cameraX = 0;
            if (cameraX > levelWidth - canvas.width) cameraX = levelWidth - canvas.width;

            for (let c of coins) {
                if (!c.collected && checkCircleRectCollision(c, player)) {
                    c.collected = true; score += 10; updateHUD();
                }
            }

            for (let i = fireballs.length - 1; i >= 0; i--) {
                let f = fireballs[i]; f.x += f.vx;
                if (f.x < cameraX || f.x > cameraX + canvas.width) { fireballs.splice(i, 1); continue; }

                let hit = false;
                for (let j = enemies.length - 1; j >= 0; j--) {
                    let e = enemies[j];
                    if (e.type !== 'fire' && checkCollision(f, e)) {
                        enemies.splice(j, 1);
                        score += 30; updateHUD();
                        hit = true; break;
                    }
                }
                if (hit) fireballs.splice(i, 1);
            }

            for (let i = enemyFireballs.length - 1; i >= 0; i--) {
                let f = enemyFireballs[i]; f.x += f.vx;
                if (f.x < cameraX - 100 || f.x > cameraX + canvas.width + 100) {
                    enemyFireballs.splice(i, 1); continue;
                }
                if (checkCollision(f, player)) {
                    loseLife();
                    enemyFireballs.splice(i, 1);
                }
            }

            for (let i = enemies.length - 1; i >= 0; i--) {
                let e = enemies[i];

                if (e.type === 'harimau' || e.type === 'gajah' || e.type === 'pemburu') {
                    e.x += e.vx;
                    if (e.x <= e.minX || e.x + e.width >= e.maxX) e.vx *= -1;

                    if (e.type === 'pemburu' && now - e.lastShoot > 2500) {
                        if (Math.abs(player.x - e.x) < 500 && Math.abs(player.y - e.y) < 100) {
                            e.lastShoot = now;
                            enemyFireballs.push({
                                x: e.vx > 0 ? e.x + e.width : e.x - 15,
                                y: e.y + 20,
                                width: 15, height: 15,
                                vx: e.vx > 0 ? 5 : -5
                            });
                        }
                    }
                } else if (e.type === 'monyet') {
                    e.x += e.vx;
                    if (e.x <= e.minX || e.x + e.width >= e.maxX) e.vx *= -1;
                    e.vy += 0.5; e.y += e.vy;
                    if (e.y >= 400 - e.height) { e.y = 400 - e.height; if (Math.random() < 0.05) e.vy = -8; }
                } else if (e.type === 'burung') {
                    e.x += e.vx; e.y = e.startY + Math.sin(now * 0.005) * 40;
                }

                if (checkCollision(player, e)) {
                    if (player.vy > 0 && player.y + player.height < e.y + 20 && e.type !== 'fire') {
                        player.vy = -10; player.jumpCount = 1;
                        enemies.splice(i, 1);
                        score += 30; updateHUD();
                    } else {
                        loseLife();
                    }
                }
            }

            for (let t of trivias) {
                if (t.active && checkCollision(player, t)) {
                    t.active = false; triggerTrivia();
                }
            }

            if (player.y > canvas.height) loseLife();
            for (let h of hazards) if (checkCollision(player, h)) loseLife();
            if (checkCollision(player, goal)) winLevel();
        }

        function checkCollision(r1, r2) {
            return (r1.x < r2.x + r2.width && r1.x + r1.width > r2.x && r1.y < r2.y + r2.height && r1.height + r1.y > r2.y);
        }
        function checkCircleRectCollision(circle, rect) {
            let testX = Math.max(rect.x, Math.min(circle.x, rect.x + rect.width));
            let testY = Math.max(rect.y, Math.min(circle.y, rect.y + rect.height));
            let distX = circle.x - testX; let distY = circle.y - testY;
            return Math.sqrt((distX * distX) + (distY * distY)) <= circle.radius;
        }

        function drawGame() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawBackground();
            // Tiang Bendera dipindahkan ke bawah supaya tidak disorok platform

            let groundColor = theme === 'bakau' ? '#7B341E' : '#8B4513';
            let topColor = theme === 'bakau' ? '#A0522D' : '#48BB78';

            for (let p of platforms) {
                if (p.type === 'ground') {
                    ctx.fillStyle = groundColor; ctx.fillRect(p.x - cameraX, p.y, p.width, p.height);
                    ctx.fillStyle = topColor; ctx.fillRect(p.x - cameraX, p.y, p.width, 10);
                } else {
                    ctx.fillStyle = '#A0522D'; ctx.fillRect(p.x - cameraX, p.y, p.width, p.height);
                    ctx.fillStyle = '#CD853F'; ctx.fillRect(p.x - cameraX, p.y, p.width, 4);
                }
            }

            for (let h of hazards) {
                ctx.fillStyle = theme === 'bakau' ? '#8B4513' : '#2B6CB0';
                ctx.fillRect(h.x - cameraX, h.y, h.width, h.height);
                ctx.fillStyle = theme === 'bakau' ? '#A0522D' : '#63B3ED';
                ctx.fillRect(h.x - cameraX + 10, h.y + 5, h.width - 20, 5);
            }

            for (let c of coins) {
                if (!c.collected) {
                    ctx.fillStyle = '#ECC94B'; ctx.beginPath(); ctx.arc(c.x - cameraX, c.y, c.radius, 0, Math.PI * 2); ctx.fill();
                    ctx.strokeStyle = '#D69E2E'; ctx.lineWidth = 2; ctx.stroke();
                }
            }

            for (let t of trivias) {
                if (t.active) {
                    ctx.fillStyle = '#8B4513'; ctx.fillRect(t.x + 15 - cameraX, t.y + 30, 10, 30);
                    ctx.fillStyle = '#3182CE'; ctx.fillRect(t.x - cameraX, t.y, t.width, 30);
                    ctx.fillStyle = '#FFFFFF'; ctx.font = '24px Arial'; ctx.fillText('?', t.x + 12 - cameraX, t.y + 24);
                }
            }

            for (let e of enemies) {
                let cx = e.x - cameraX;
                if (e.type === 'harimau') {
                    ctx.fillStyle = '#DD6B20'; ctx.fillRect(cx, e.y, e.width, e.height);
                    ctx.fillStyle = '#000000'; for (let s = 5; s < e.width; s += 15) ctx.fillRect(cx + s, e.y, 4, e.height);
                    let faceDir = e.vx > 0 ? e.width - 10 : 0;
                    ctx.fillStyle = '#FBD38D'; ctx.fillRect(cx + faceDir, e.y + 5, 10, 15);
                }
                else if (e.type === 'gajah') {
                    ctx.fillStyle = '#A0AEC0'; ctx.fillRect(cx, e.y, e.width, e.height);
                    let trunkDir = e.vx > 0 ? e.width : -10; ctx.fillRect(cx + trunkDir, e.y + 10, 10, e.height - 10);
                    ctx.fillStyle = '#FFFFFF'; let tuskDir = e.vx > 0 ? e.width : -5;
                    ctx.beginPath(); ctx.moveTo(cx + tuskDir, e.y + 20); ctx.lineTo(cx + tuskDir + (e.vx > 0 ? 10 : -10), e.y + 30); ctx.lineTo(cx + tuskDir, e.y + 25); ctx.fill();
                }
                else if (e.type === 'monyet') {
                    ctx.fillStyle = '#8B4513'; ctx.fillRect(cx, e.y, e.width, e.height);
                    let faceDir = e.vx > 0 ? e.width - 15 : 5; ctx.fillStyle = '#FBB6CE'; ctx.fillRect(cx + faceDir, e.y + 5, 10, 10);
                    ctx.strokeStyle = '#8B4513'; ctx.lineWidth = 3; let tailDir = e.vx > 0 ? 0 : e.width;
                    ctx.beginPath(); ctx.arc(cx + tailDir, e.y + e.height - 10, 8, Math.PI, 0); ctx.stroke();
                }
                else if (e.type === 'burung') {
                    ctx.fillStyle = '#3182CE'; let flap = Math.sin(Date.now() * 0.02) * 10;
                    ctx.beginPath(); ctx.moveTo(cx, e.y + 10); ctx.lineTo(cx + 15, e.y + 10 + flap); ctx.lineTo(cx + e.width, e.y); ctx.fill();
                }
                else if (e.type === 'pemburu') {
                    ctx.fillStyle = '#2D3748'; ctx.fillRect(cx, e.y, e.width, e.height);
                    let faceDir = e.vx > 0 ? e.width - 15 : 5;
                    ctx.fillStyle = '#FBD38D'; ctx.fillRect(cx + faceDir, e.y + 5, 10, 15);
                    ctx.fillStyle = '#1A202C'; ctx.fillRect(cx - 5, e.y - 5, e.width + 10, 10);
                }
                else if (e.type === 'fire') {
                    let flicker = Math.sin(Date.now() * 0.01) * 5;
                    ctx.fillStyle = '#DD6B20'; ctx.beginPath(); ctx.moveTo(cx, e.y + e.height); ctx.lineTo(cx + e.width / 2, e.y + flicker); ctx.lineTo(cx + e.width, e.y + e.height); ctx.fill();
                    ctx.fillStyle = '#ECC94B'; ctx.beginPath(); ctx.moveTo(cx + 6, e.y + e.height); ctx.lineTo(cx + e.width / 2, e.y + 10 + flicker * 0.5); ctx.lineTo(cx + e.width - 6, e.y + e.height); ctx.fill();
                }
            }

            for (let f of fireballs) {
                let cx = f.x - cameraX; ctx.fillStyle = '#DD6B20';
                ctx.beginPath(); ctx.arc(cx + 10, f.y + 10, 10, 0, Math.PI * 2); ctx.fill();
                ctx.fillStyle = '#ECC94B'; ctx.beginPath(); ctx.arc(cx + 10, f.y + 10, 5, 0, Math.PI * 2); ctx.fill();
            }

            for (let f of enemyFireballs) {
                let cx = f.x - cameraX; ctx.fillStyle = '#9F7AEA';
                ctx.beginPath(); ctx.arc(cx + 7.5, f.y + 7.5, 7.5, 0, Math.PI * 2); ctx.fill();
                ctx.fillStyle = '#D6BCFA'; ctx.beginPath(); ctx.arc(cx + 7.5, f.y + 7.5, 3, 0, Math.PI * 2); ctx.fill();
            }


            // Lukis Tiang Bendera (Flagpole)
            ctx.fillStyle = '#CBD5E0'; // Warna tiang kelabu
            ctx.fillRect(goal.x - cameraX + 25, goal.y, 10, goal.height + 50); // Tiang lebih tinggi sikit

            // Lukis Puncak Tiang (Bulatan Emas)
            ctx.fillStyle = '#ECC94B';
            ctx.beginPath();
            ctx.arc(goal.x - cameraX + 30, goal.y, 8, 0, Math.PI * 2);
            ctx.fill();

            // Lukis Bendera Merah
            ctx.fillStyle = '#E53E3E'; // Merah
            ctx.beginPath();
            ctx.moveTo(goal.x + 35 - cameraX, goal.y + 10); // Mula kat tiang
            ctx.lineTo(goal.x + 75 - cameraX, goal.y + 25); // Hujung bendera
            ctx.lineTo(goal.x + 35 - cameraX, goal.y + 40); // Balik ke tiang
            ctx.closePath();
            ctx.fill();

            let cx = player.x - cameraX;
            let cy = player.y;
            let w = player.width;

            // Kasut (Bawah sekali Y: 52-60)
            ctx.fillStyle = '#4A3018';
            ctx.fillRect(cx + 2, cy + 52, w - 4, 8);

            // Seluar Renjer (Y: 36-52)
            let pantColor = currentLevel >= 4 ? '#C53030' : '#2F855A';
            ctx.fillStyle = pantColor;
            ctx.fillRect(cx + 6, cy + 38, w - 12, 14);

            // Tali Pinggang (Y: 34-38)
            ctx.fillStyle = '#2D3748';
            ctx.fillRect(cx + 4, cy + 34, w - 8, 4);
            ctx.fillStyle = '#ECC94B'; // Kepala Tali Pinggang Emas
            ctx.fillRect(cx + (w / 2) - 3, cy + 34, 6, 4);

            // Baju Khaki (Y: 20-34)
            ctx.fillStyle = '#D2B48C';
            ctx.fillRect(cx + 4, cy + 20, w - 8, 14);

            // Lengan & Tangan
            ctx.fillStyle = '#C3A378'; // Lengan baju
            let armX = player.facingLeft ? cx - 2 : cx + w - 6;
            ctx.fillRect(armX, cy + 20, 8, 10);
            ctx.fillStyle = '#FBD38D'; // Kulit tangan
            ctx.fillRect(armX, cy + 30, 8, 4);

            // Muka (Y: 10-20)
            ctx.fillStyle = '#FBD38D';
            ctx.fillRect(cx + 8, cy + 10, w - 16, 10);

            // Mata
            ctx.fillStyle = '#000';
            let eyeX = player.facingLeft ? cx + 10 : cx + w - 14;
            ctx.fillRect(eyeX, cy + 12, 4, 4);

            // Topi Lebar Renjer (Rim Y: 8-12, Kubah Y: 0-10)
            ctx.fillStyle = '#8B4513';
            ctx.beginPath();
            ctx.arc(cx + w / 2, cy + 10, 12, Math.PI, 0); // Kubah atas
            ctx.fill();
            ctx.fillRect(cx - 6, cy + 8, w + 12, 4); // Lebar rim topi

            // Lencana Topi Daun
            ctx.fillStyle = '#48BB78';
            let badgeX = player.facingLeft ? cx + w / 2 - 6 : cx + w / 2 + 2;
            ctx.fillRect(badgeX, cy + 4, 4, 4);
        }

        function triggerTrivia() {
            gameState = 'TRIVIA';
            keys.left = false; keys.right = false;

            hideAllScreens();
            screens.trivia.classList.remove('hidden');

            let diffTarget = 1;
            if (currentLevel >= 4) diffTarget = 2;
            if (currentLevel === 6) diffTarget = 3;

            // Carian soalan yang wujud dalam pangkalan data admin yang belum ditanya
            let pool = triviaDB.filter(q => q.diff === diffTarget && !usedQuestions.includes(q.q));
            if (pool.length === 0) pool = triviaDB.filter(q => !usedQuestions.includes(q.q));
            if (pool.length === 0) { usedQuestions = []; pool = triviaDB; }

            // Fallback kecemasan jika admin terpadam SEMUA soalan
            if (pool.length === 0) {
                pool = [{ q: "Sila minta admin masukkan soalan baharu!", options: ["OK", "Faham", "Baik"], answer: 0, diff: 1 }];
            }

            const qData = pool[Math.floor(Math.random() * pool.length)];
            currentTriviaBlock = qData;
            usedQuestions.push(qData.q);

            document.getElementById('questionText').innerText = qData.q;

            const container = document.getElementById('answersContainer');
            container.innerHTML = '';

            qData.options.forEach((opt, idx) => {
                const btn = document.createElement('button');
                btn.className = 'w-full text-left bg-gray-100 hover:bg-green-100 border-2 border-gray-300 hover:border-green-500 p-4 rounded-lg font-bold transition duration-200';
                btn.innerText = String.fromCharCode(65 + idx) + ". " + opt;
                btn.onclick = () => checkAnswer(idx, qData.answer);
                container.appendChild(btn);
            });
        }

        function checkAnswer(selectedIdx, correctIdx) {
            if (selectedIdx === correctIdx) {
                let bonus = 50 * currentLevel;
                score += bonus;
                alert(`Betul! Anda mendapat ${bonus} markah.`);
            } else {
                lives -= 1;
                alert("Salah! Jawapan sebenar ialah:\n\n" + currentTriviaBlock.options[correctIdx]);
                if (lives <= 0) { gameOver(); return; }
            }
            lastTimeTick = Date.now();
            updateHUD(); hideAllScreens(); gameState = 'PLAYING';
        }

        function hideAllScreens() {
            Object.values(screens).forEach(s => s.classList.add('hidden'));
        }

        function loseLife() {
            lives -= 1;
            updateHUD();
            if (lives <= 0) {
                gameOver();
            } else {
                player.x = cameraX + 50; player.y = 100; player.vx = 0; player.vy = 0; player.jumpCount = 0;
                enemyFireballs = [];
                timeLeft += 10; lastTimeTick = Date.now();
            }
        }

        function updateHUD() {
            scoreDisplay.innerText = score;
            livesDisplay.innerText = lives;
            levelDisplay.innerText = currentLevel;
            timeDisplay.innerText = timeLeft;
        }

        function showEndRank(rankIndex) {
            const rankDiv = document.getElementById('rankContainer');
            const rankText = document.getElementById('finalRank');

            if (rankIndex >= 0 && rankIndex < 10) {
                rankDiv.classList.remove('hidden');
                rankText.innerText = `Tangga #${rankIndex + 1} üèÜ`;
            } else if (rankIndex >= 10) {
                rankDiv.classList.remove('hidden');
                rankText.innerText = `Tangga #${rankIndex + 1}`;
                rankText.className = "text-xl font-bold text-gray-400 mt-1";
            } else {
                rankDiv.classList.add('hidden');
            }
        }

        function gameOver() {
            gameState = 'GAMEOVER';

            // Set kedudukan kepada hidden dahulu semntara menunggu Cloud Server
            document.getElementById('rankContainer').classList.add('hidden');

            saveHighScoreAsync(playerName, score); // Simpan skor secara Async Backend

            hideAllScreens();
            screens.end.classList.remove('hidden');
            document.getElementById('endTitle').innerText = "Misi Gagal";
            document.getElementById('endTitle').className = "text-5xl font-bold mb-2 text-center text-red-500";
            document.getElementById('endMessage').innerText = `Anda tewas di Tahap ${currentLevel}.`;
            document.getElementById('finalScore').innerText = score;
            // showEndRank(rank); di panggil dalam promise saveHighScoreAsync

            document.getElementById('nextLevelBtn').classList.add('hidden');
            document.getElementById('restartBtn').innerText = "Main Semula";
            document.getElementById('restartBtn').classList.remove('hidden');
        }

        function winLevel() {
            gameState = 'GAMEOVER';
            hideAllScreens();

            if (currentLevel < 6) {
                screens.end.classList.remove('hidden');
                document.getElementById('endTitle').innerText = `Tahap ${currentLevel} Selesai!`;
                document.getElementById('endTitle').className = "text-5xl font-bold mb-2 text-center text-green-400";
                document.getElementById('endMessage').innerText = "Hebat! Teruskan ke tahap yang lebih sukar.";

                lives += 1;
                score += (timeLeft * 2) + (100 * currentLevel);
                updateHUD();
                document.getElementById('finalScore').innerText = score;

                document.getElementById('nextLevelBtn').classList.remove('hidden');
                document.getElementById('restartBtn').classList.add('hidden');
            } else {
                screens.end.classList.remove('hidden');
                document.getElementById('endTitle').innerText = "MISI SELESAI!";
                document.getElementById('endTitle').className = "text-5xl font-bold mb-2 text-center text-yellow-400";
                document.getElementById('endMessage').innerText = "Tahniah! Anda berjaya menamatkan kesemua 6 Tahap!";

                score += 5000 + (timeLeft * 5);
                updateHUD();

                document.getElementById('rankContainer').classList.add('hidden');
                saveHighScoreAsync(playerName, score); // Simpan markah selepas menang penuh

                document.getElementById('finalScore').innerText = score;
                // showEndRank(rank); dipanggil dalam promise

                document.getElementById('nextLevelBtn').classList.add('hidden');
                document.getElementById('restartBtn').innerText = "Main Semula";
                document.getElementById('restartBtn').classList.remove('hidden');
            }
        }

        function startLevel() {
            player.x = 50; player.y = 200; player.vx = 0; player.vy = 0; player.facingLeft = false; player.jumpCount = 0;
            fireballs = []; enemyFireballs = [];

            if (currentLevel >= 4) btnShoot.classList.remove('hidden');
            else btnShoot.classList.add('hidden');

            buildLevel(currentLevel);
            updateHUD();
            gameState = 'PLAYING';
            hideAllScreens();
        }
        // Wrap all button bindings in DOMContentLoaded to prevent silent attachment failures
        document.addEventListener('DOMContentLoaded', () => {

            document.getElementById('openAdminLoginBtn').addEventListener('click', () => {
                hideAllScreens();
                screens.adminLogin.classList.remove('hidden');
                gameState = 'ADMIN_LOGIN'; // Set state so gameLoop doesn't draw
            });

            document.getElementById('adminLoginBackBtn').addEventListener('click', () => {
                hideAllScreens();
                screens.register.classList.remove('hidden');
                gameState = 'REGISTER';
            });

            document.getElementById('adminLoginSubmitBtn').addEventListener('click', () => {
                const u = document.getElementById('adminUsername').value;
                const p = document.getElementById('adminPassword').value;

                console.log("Admin Login clicked:", { u, expected: ADMIN_USER });

                if (u === ADMIN_USER && p === ADMIN_PASS) {
                    document.getElementById('adminUsername').value = '';
                    document.getElementById('adminPassword').value = '';

                    hideAllScreens();
                    gameState = 'ADMIN'; // Set state to stop physics loop and background drawing

                    try {
                        if (!triviaDB || triviaDB.length === 0) triviaDB = [...defaultTriviaDB];
                        renderAdminQuestions();
                        console.log("Admin panel successfully rendered.");
                    } catch (e) {
                        console.error("Error rendering admin panel:", e);
                    }
                    screens.adminDash.classList.remove('hidden');
                } else {
                    alert("ID Admin atau Kata Laluan SALAH!");
                }
            });

            document.getElementById('adminLogoutBtn').addEventListener('click', () => {
                hideAllScreens();
                screens.register.classList.remove('hidden');
                gameState = 'REGISTER';
            });

            document.getElementById('submitNameBtn').addEventListener('click', () => {
                const input = document.getElementById('playerNameInput').value.trim();
                if (input.length > 0) {
                    playerName = input;
                    document.getElementById('displayPlayerName').innerText = playerName;
                    hideAllScreens();
                    screens.start.classList.remove('hidden');
                } else { alert("Sila masukkan nama anda!"); }
            });

            document.getElementById('startBtn').addEventListener('click', () => {
                score = 0; lives = 5; currentLevel = 1; usedQuestions = [];
                startLevel();
            });

            document.getElementById('nextLevelBtn').addEventListener('click', () => {
                if (currentLevel === 1 || currentLevel === 2) {
                    document.getElementById('interstitialNameDisplay').innerText = playerName;

                    let imgEl = document.getElementById('interstitialImg');
                    imgEl.classList.add('opacity-0'); // Sembunyikan sementara memuat turun

                    if (currentLevel === 1) {
                        imgEl.src = "tanjung_piai.png";
                    } else if (currentLevel === 2) {
                        imgEl.src = "pulau_kukup.png";
                    }

                    imgEl.onload = () => {
                        imgEl.classList.remove('opacity-0');
                        imgEl.classList.add('opacity-100');
                        imgEl.classList.add('transition-opacity');
                        imgEl.classList.add('duration-500');
                    };

                    hideAllScreens();
                    screens.interstitial.classList.remove('hidden');

                    // Tembak bunga api (confetti)
                    let duration = 3 * 1000;
                    let end = Date.now() + duration;

                    (function frame() {
                        confetti({
                            particleCount: 5,
                            angle: 60,
                            spread: 55,
                            origin: { x: 0 },
                            zIndex: 100
                        });
                        confetti({
                            particleCount: 5,
                            angle: 120,
                            spread: 55,
                            origin: { x: 1 },
                            zIndex: 100
                        });

                        if (Date.now() < end) {
                            requestAnimationFrame(frame);
                        }
                    }());

                } else {
                    currentLevel++;
                    startLevel();
                }
            });

            document.getElementById('interstitialImg').addEventListener('click', () => {
                currentLevel++;
                startLevel();
            });

            document.getElementById('interstitialNextBtn').addEventListener('click', () => {
                currentLevel++;
                startLevel();
            });

            document.getElementById('restartBtn').addEventListener('click', () => {
                hideAllScreens();
                screens.start.classList.remove('hidden');
            });

            function gameLoop() {
                if (gameState === 'PLAYING') {
                    updatePhysics();
                    drawGame();
                } else if (gameState !== 'ADMIN' && gameState !== 'ADMIN_LOGIN' && gameState !== 'LEADERBOARD') {
                    lastTimeTick = Date.now();
                    drawGame();
                }
                requestAnimationFrame(gameLoop);
            }

            const aiBank = [
                { q: "Menurut Jabatan Perhutanan, apakah zon yang paling dirahsiakan di Johor yang tidak boleh diakses awam?", options: ["Zon Rimba Teras", "Zon Ekonomi Awam", "Zon Perkhemahan Bebas"], answer: 0, diff: 3 },
                { q: "Hutan Paya Bakau memainkan peranan menyerap gas apa dari udara lebih banyak daripada pokok biasa?", options: ["Gas Oksigen Berlebihan", "Gas Karbon Dioksida 4x Ganda", "Gas Metana Pembakaran"], answer: 1, diff: 2 },
                { q: "Apakah spesies burung penting yang singgah di Tanjung Piai semasa migrasi antarabangsa laluan Asia-Australasia?", options: ["Burung Pacat Telinga Merah", "Burung Siput Biasa", "Burung Hijrah Kaki Abu-abu (Waders)"], answer: 2, diff: 2 },
                { q: "Air Terjun Buaya Sangkut merupakan daya tarikan sungai utama di taman mana?", options: ["Taman Negara Johor Endau-Rompin", "Taman Marin Kepulauan Sultan Iskandar", "Kawasan Rekreasi Gunung Arong"], answer: 0, diff: 1 },
                { q: "Apakah nama puteri mitos yang memberikan 7 syarat mustahil kepada Sultan Melaka?", options: ["Puteri Santubong", "Puteri Gunung Banang", "Puteri Gunung Ledang"], answer: 2, diff: 1 },
                { q: "Endau-Rompin ditubuhkan secara rasmi oleh Kerajaan Negeri Johor pada tahun...", options: ["1920-an", "1993", "2015"], answer: 1, diff: 3 }
            ];

            document.getElementById('aiGenBtn').addEventListener('click', () => {
                const diffTarget = parseInt(document.getElementById('newDiff').value);
                const pool = aiBank.filter(a => a.diff === diffTarget);
                const c = pool.length > 0 ? pool[Math.floor(Math.random() * pool.length)] : aiBank[Math.floor(Math.random() * aiBank.length)];

                document.getElementById('newQuestion').value = c.q;
                document.getElementById('newOpt0').value = c.options[0];
                document.getElementById('newOpt1').value = c.options[1];
                document.getElementById('newOpt2').value = c.options[2];
                document.getElementById('newAnswer').value = c.answer;
            });

            async function renderTop3() {
                const container = document.getElementById('top3Container');
                const list = document.getElementById('top3List');

                if (!supabaseClient) {
                    container.classList.add('hidden');
                    return;
                }

                try {
                    const { data: board, error } = await supabaseClient.from('ptnj_leaderboard')
                        .select('*')
                        .order('score', { ascending: false })
                        .limit(3);

                    if (board && board.length > 0) {
                        container.classList.remove('hidden');
                        list.innerHTML = board.map((r, i) => {
                            let medal = i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : 'ü•â';
                            return `<div class="mb-1">${medal} <b class="text-white tracking-wider">${r.name.toUpperCase()}</b> <span class="bg-gray-700 rounded px-2 py-0.5 ml-1 drop-shadow text-yellow-300">${r.score}</span></div>`;
                        }).join('');
                    } else { container.classList.add('hidden'); }
                } catch (e) {
                    container.classList.add('hidden');
                }
            }

            async function initializeApp() {
                try {
                    if (supabaseClient) {
                        await loadTriviaDB();
                        renderTop3(); // Memuat turun Top 3 Live dari Server
                    }
                } catch (e) { console.error("Initialization error:", e); }
            }

            try {
                buildLevel(1);
                initializeApp();
                requestAnimationFrame(gameLoop);
                console.log("Game fully initialized");
            } catch (e) {
                console.error("Game crash on startup:", e);
            }

        }); // END DOMContentLoaded
    </script>
</body>

</html>
```